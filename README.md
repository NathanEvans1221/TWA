# TWA
Trusted Web Activity - TWA 就是讓網頁程式偽裝成原生 App，讓使用者感覺不到差別。

## 2. 前置需求 (Prerequisites)
在開始之前，請確保開發環境已安裝以下工具：

*   **Node.js**: 版本 12 或以上 (建議使用 LTS 版本)。
*   **Java Development Kit (JDK)**: 版本 8 或 11。
*   **Android Studio**: 用於安裝 **Android SDK** 和管理 **Android Virtual Device (AVD)** (模擬器)。
*   **Bubblewrap CLI**: Google 官方提供的 TWA 生成工具。

### 安裝 Bubblewrap CLI
在終端機 (Terminal) 執行以下指令：
- Node.js 22
```bash
npm install -g @bubblewrap/cli
```

### 步驟一：初始化專案 (Initialize Project)

1.  建立一個新的資料夾用於存放 Android 專案檔案。
2.  在該資料夾中開啟終端機。
3.  執行初始化指令，並指定網頁的 **Web App Manifest** URL：

```bash
cd android-app

bubblewrap init --manifest https://ai-temple.vercel.app/manifest.json
```
- 執行過程中，請依序回答問題：

1. Install JDK?: 輸入 Y (或直接按 Enter)。
2. Install Android SDK?: 輸入 Y (或直接按 Enter)。
3. Review licenses?: 輸入 Y，閱讀後按 y 接受所有條款。
4. App Details:
    - 大部分選項 Bubblewrap 會從 manifest.json 自動抓取，您可以直接按 Enter 使用預設值。
    - Application ID: 確認為 com.aitemple.twa (或您喜歡的 ID)。
    - KeyStore: 如果詢問是否建立 KeyStore，請回答 Y，並設定一組密碼，例如:123456 (請記住此密碼)。
完成後，請告訴我，我將協助您進行下一步（建置 APK 與設定 assetlinks.json）。

- 安裝畫面
```bash
❯ bubblewrap init --manifest https://ai-temple.vercel.app/manifest.json
,-----.        ,--.  ,--.  ,--.
|  |) /_,--.,--|  |-.|  |-.|  |,---.,--.   ,--,--.--.,--,--.,---.
|  .-.  |  ||  | .-. | .-. |  | .-. |  |.'.|  |  .--' ,-.  | .-. |
|  '--' '  ''  | `-' | `-' |  \   --|   .'.   |  |  \ '-'  | '-' '
`------' `----' `---' `---'`--'`----'--'   '--`--'   `--`--|  |-'
                                                           `--'
? Do you want Bubblewrap to install the JDK (recommended)?
  (Enter "No" to use your own JDK 17 installation) Yes
Downloading the JDK 17 Sources...
 >> [████████████████████████████████████████] 100% | 174793k of 174783k
Decompressing the JDK 17 Sources...
Downloading the JDK 17 Binaries...
 >> [████████████████████████████████████████] 100% | 181543k of 181543k
Decompressing the JDK 17 Binaries...
? Do you want Bubblewrap to install the Android SDK (recommended)?
  (Enter "No" to use your own Android SDK installation) Yes
  ? Do you agree to the Android SDK terms and conditions at https://developer.android.com/studio/terms.html? Yes
Downloading Android SDK to C:\Users\chiis\.bubblewrap\android_sdk
Downloading the Android SDK...
 >> [████████████████████████████████████████] 100% | 84490k of 76751k
Decompressing the Android SDK...
Initializing application from Web Manifest:
        -  https://ai-temple.vercel.app/manifest.json
WARNING: Trusted Web Activities are currently incompatible with applications
targeting children under the age of 13. Check out the Play for Families
policies to learn more.
https://play.google.com/console/about/families/

Web app details (1/5)

The application generated by Bubblewrap will open a Progressive Web App when
started from the Android launcher. Please enter the following details about
the PWA:

        - Domain: the domain / origin where the PWA is hosted.
          Example: example.com

        - URL path: an URL path relative to the root of the origin,
          opened when the application is started from the home screen.
          Examples:

                - To open https://example.com/: /
                - To open https://example.com/path-to-pwa/: /path-to-pwa/

? Domain: (ai-temple.vercel.app) 
```
### Web App Manifest 欄位說明 (`android-app/manifest.json`)

`manifest.json` 是 PWA (Progressive Web App) 的核心設定檔。當您要切換到不同的網站時，需要修改以下欄位：

| 欄位 | 說明 | 修改前 | 修改後 |
|------|------|--------|--------|
| `short_name` | APP 簡短名稱 | `"AI Temple"` | `"Math Monsters Shooter"` |
| `name` | APP 完整名稱 | `"AI Temple"` | `"Math Monsters Shooter"` |
| `icons[].src` | 圖示 URL | `"https://ai-temple.vercel.app/icon.png"` | `"https://math-monsters-shooter.liawchiisen.workers.dev/icon.png"` |
| `start_url` | 啟動網址 | `"https://ai-temple.vercel.app/"` | `"https://math-monsters-shooter.liawchiisen.workers.dev/"` |
| `scope` | 作用範圍 | `"https://ai-temple.vercel.app/"` | `"https://math-monsters-shooter.liawchiisen.workers.dev/"` |
| `description` | 描述文字 | `"AI Temple Application"` | `"Math Monsters Shooter Application"` |

> ⚠️ **注意**：修改 `manifest.json` 後，也需要同步更新 `twa-manifest.json` 中的對應欄位（如 `host`、`name`、`iconUrl`、`fullScopeUrl` 等）。

### 修改網址設定 (Updating URL Configuration)

若之後需要修改 APP 開啟的網址，請編輯 `android-app/twa-manifest.json` 檔案：

1.  **修改重要欄位**：
    *   `host` (第 3 行): 您的網站主網域 (例如: `ai-temple.vercel.app`)。
    *   `name` (第 4 行): APP 的名稱。
    *   `shortName` (第 5 行): APP 的簡短名稱。
    *   `startUrl` (第 15 行): APP 開啟後的初始路徑 (通常為 `/`)。
    *   `fullScopeUrl` (第 35 行): APP 的作用範圍 (例如: `https://ai-temple.vercel.app/`)。
    *   `iconUrl` (第 16 行): 圖示的網址路徑。

2.  **套用變更**：
    修改完 JSON 檔案後，在 `android-app` 目錄下執行以下指令來更新專案並重新建置：

    > ⚠️ **重要提醒**：`bubblewrap update` 需要從 `twa-manifest.json` 中的 `webManifestUrl` 下載 manifest 檔案。
    > 若 `webManifestUrl` 設定為本地位址（如 `http://localhost:8088/manifest.json`），
    > 請**先啟動本地伺服器**，否則會出現 `Unexpected token '<', "<!DOCTYPE "... is not valid JSON` 錯誤。

    ```bash
    # 切換到 android-app 目錄
    cd android-app

    # 🚀 啟動本地 HTTP 伺服器（在另一個終端機視窗執行）
    # 預設使用 port 8088，確保與 twa-manifest.json 中的 webManifestUrl 一致
    npx -y http-server -p 8088 --cors

    # 更新專案設定（在原本的終端機視窗執行）
    bubblewrap update

    # 重新建置 APK
    bubblewrap build
    ```

    > 💡 **提示**：Port 8081 可能被 WSL 等其他服務佔用，建議使用 8088 或其他未被佔用的 port。

---

## 🔧 常見問題與解決方案 (Troubleshooting)

### 1. 忘記 KeyStore 密碼

如果您忘記了 KeyStore 密碼，執行 `bubblewrap build` 時會出現以下錯誤：

```
java.io.IOException: keystore password was incorrect
```

**解決方案**：重新生成 KeyStore（需刪除舊的 KeyStore 檔案）

```powershell
# 切換到 android-app 目錄
cd android-app

# 刪除舊的 KeyStore
Remove-Item android.keystore

# 重新初始化專案（會重新建立 KeyStore）
# 請確保 http-server 正在運行
bubblewrap init --manifest http://localhost:8088/manifest.json
```

> ⚠️ **警告**：如果已經用舊的 KeyStore 發布過 APP 到 Google Play，重新生成 KeyStore 後將**無法更新該 APP**，只能發布全新的 APP。請務必妥善保管 KeyStore 密碼！

---

### 2. JVM 記憶體不足

執行 `bubblewrap build` 時出現以下錯誤：

```
Error occurred during initialization of VM
Could not reserve enough space for 1572864KB object heap
```

**原因**：Gradle 預設需要 1.5GB 記憶體，但系統無法分配足夠的連續記憶體空間。

**解決方案**：修改 `android-app/gradle.properties`，降低 JVM 記憶體設定

```properties
# 原本的設定（1.5GB）
org.gradle.jvmargs=-Xmx1536m

# 改為較低的設定（512MB）
org.gradle.jvmargs=-Xmx512m
```

> 💡 **提示**：每次執行 `bubblewrap init` 都會重新產生 `gradle.properties`，記得再次修改記憶體設定。

---

### 3. Android SDK 路徑衝突

執行 `bubblewrap build` 時出現以下錯誤：

```
Several environment variables and/or system properties contain different paths to the SDK.

ANDROID_HOME: C:\Users\chiis\.bubblewrap\android_sdk
ANDROID_SDK_ROOT: C:\Users\chiis\AppData\Local\Android\Sdk
```

**原因**：系統同時設定了 `ANDROID_HOME` 和 `ANDROID_SDK_ROOT` 兩個不同的 SDK 路徑。

**解決方案**：在執行 `bubblewrap build` 前，先設定正確的環境變數

```powershell
# 移除 ANDROID_SDK_ROOT，統一使用 ANDROID_HOME
$env:ANDROID_SDK_ROOT = $null
$env:ANDROID_HOME = "C:\Users\chiis\.bubblewrap\android_sdk"

# 執行建置
bubblewrap build
```

> 💡 **提示**：如果要永久解決此問題，可以在系統環境變數中移除 `ANDROID_SDK_ROOT`，或將其設定為與 `ANDROID_HOME` 相同的路徑。

---
完成後，請告訴我，我將協助您進行下一個步驟。
